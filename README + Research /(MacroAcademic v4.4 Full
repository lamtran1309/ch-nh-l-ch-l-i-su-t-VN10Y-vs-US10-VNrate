 README + Research / Interpretation Guide cho phiên bản mới (MacroAcademic v4.4 Full). Anh có thể copy thẳng vào phần mô tả script trên TradingView hoặc lưu thành file README.md.

---

# Macro Alert System v4.4 – Full (Macro + Indices Research)

`MacroAcademic v4.4 Full`

## 1. Mục tiêu & phạm vi

Script này được thiết kế như một **bộ khung nghiên cứu vĩ mô – thị trường** theo phong cách “Bloomberg style”, tập trung vào:

1. **Khối Macro (Pane 1–5)**

   * Giám sát lãi suất, đường cong lợi suất, chênh lệch quốc tế, FX.
   * Tạo **4 trụ tín hiệu** (Stress, Yield curve, International, Spread).
   * Xây dựng **3-layer Risk Analysis** (Funding – Cycle – External).
   * Tính **Composite Risk Score (0–100)** và **Policy Pressure Index (0–100)**.

2. **Khối Indices Research (Panel 1–4)**

   * Thống kê hành vi các chỉ số HOSE theo từng **macro bucket B0–B4**.
   * Map **Market Regime** của 6 chỉ số (VNINDEX, VN30, VN100, VNALL, VNMID, VNSMALL).
   * Map **Sector Rotation** của 11 ngành (VNFIN, VNREAL, VNCOND, …) so với VNINDEX.
   * Xây **Transition matrix** giữa các bucket (từ Bx hôm nay → By sau L ngày).

Script hướng tới dùng cho **nghiên cứu – backtest tư duy vĩ mô**, không dùng như 1 indicator vào/ra lệnh trực tiếp.

---

## 2. Kiến trúc tổng thể

Script gồm hai “trục chính”:

### 2.1. Trục Macro (Pane 1–5 – chọn bằng `Che do hien thi`)

1. **Pane 1 – Lãi suất & chính sách**

   * Hiển thị: VNINTR (policy), VN02Y, VN10Y, VNINBR (interbank), US10Y.
   * Có label chạy theo giá cho từng series.

2. **Pane 2 – Spreads & z-score**

   * Chọn view:

     * `Spreads`: các chênh lệch gốc (Stress, Curve, Intl, Long-Short).
     * `Z-scores`: z-score thường.
     * `Robust Z-scores`: robust z-score (winsorization).
     * `Percentile-thresholds`: chênh lệch so với ngưỡng percentile.

3. **Pane 3 – Risk score & Dashboard**

   * Plot **risk_pct (0–100)**.
   * Background tô màu theo mức rủi ro.
   * Tính thêm **percent-rank** cho từng trụ (Stress, Curve, Intl, Spread).

4. **Pane 4 – 3-Layer Risk Analysis**

   * L1: Funding (thanh khoản, stress).
   * L2: Cycle/Macro (yield curve + long-short spread).
   * L3: External (intl diff + FX).
   * Mỗi layer có weight riêng và % risk riêng.

5. **Pane 5 – Policy Pressure & Decomposition**

   * Tính **Policy Pressure Index (0–100)**.
   * Table “Research Guide” (dưới) – giải thích 3 vùng: easing / neutral / constraint.
   * Table “Decomposition” (trên phải) – phân rã đóng góp của 4 block: Funding / Curve / External / FX.

### 2.2. Trục Indices Research (Panel 1–4 – `Chon panel hien thi`)

1. **Panel 1 – Macro Weather**

   * Bảng tóm tắt bucket hiện tại, 4 trụ macro (Stress, Curve, Intl, Spread) và thống kê VNINDEX (AvgR20, Win%, AvgDD20) trong bucket hiện tại.

2. **Panel 2 – Market Regime Map (Table A)**

   * Bảng thống kê cho 6 chỉ số HOSE theo bucket đang chọn:

     * AvgR20, Win20%, AvgR60, AvgDD20, N20.

3. **Panel 3 – Sector Rotation Map (Table B)**

   * Xếp hạng **Top 3 / Bottom 3** ngành theo **AvgRR20** (excess return vs VNINDEX).

4. **Panel 4 – Transition Summary (Table C)**

   * Tính xác suất từ bucket hiện tại Bx sau L ngày sẽ:

     * Lên bucket cao hơn,
     * Ở lại bucket,
     * Giảm về bucket thấp hơn.

---

## 3. Dữ liệu & tham số quan trọng

### 3.1. Tickers macro (mặc định)

* `VNINTR`  : Policy rate (SBV).
* `VN02Y`   : Bond 2Y.
* `VN10Y`   : Bond 10Y.
* `VNINBR`  : Interbank rate.
* `US10Y`   : US 10Y.
* `USDVND`  : FX (input).
* `USINTR`  : Fed policy rate (input).

Có thể thay đổi `fx_symbol` và `fed_symbol` tùy hạ tầng dữ liệu.

### 3.2. Robust Mode & Academic options

* `Robust Mode (Academic)`:

  * `"Shock-sensitive"`: ít clip outliers → phản ứng nhạy với cú sốc.
  * `"Fully-robust"`   : winsorize mạnh hơn → mượt hơn, ít bị spike.
* `Use log returns`:

  * Bật để dùng log return cho thống kê R5/R20/R60.
* `Clip upper / lower return`:

  * Cắt biên outlier của return: ví dụ +200% / -80%.

### 3.3. Threshold Mode

`Che do nguong` có 3 lựa chọn:

1. **Static**

   * Dùng ngưỡng cố định theo kinh nghiệm (vd: Stress > 1.5, Curve < 0, …).

2. **Dynamic (z-score)**

   * Dùng robust z-score so với lịch sử (len_stats).
   * Ví dụ: Stress_z > 1.0 → stress_high.

3. **Percentile-based**

   * Dùng percentile theo phân phối lịch sử (504 bars).
   * Ví dụ: Stress > 85th percentile → stress_high.

→ 3 trụ: **Static** = trực quan, **Dynamic** = theo chuẩn hóa, **Percentile** = dựa trên phân vị.

---

## 4. 4 trụ Macro & Composite Risk Score

### 4.1. Bốn trụ chính

1. **Liquidity stress**: `interbank_rate - policy_rate`

   * High = bad (căng thanh khoản).

2. **Yield curve standard**: `bond_10y - bond_2y`

   * Low/negative = bad (inversion).

3. **International yield diff**: `bond_10y - us_10y`

   * Low = bad (kém hấp dẫn tương đối).

4. **Long-short spread**: `bond_10y - policy_rate`

   * Low = bad (policy quá cao so với dài hạn).

Từ các ngưỡng, script tạo 4 biến boolean:
`stress_high`, `curve_inversion`, `intl_warning`, `spread_warning`.

### 4.2. 3-Layer Risk

* **Layer 1 – Funding**: dựa vào `stress_high`.
* **Layer 2 – Cycle**: dựa vào `curve_inversion` + `spread_warning`.
* **Layer 3 – External**: dựa vào `intl_warning` + FX pressure.

Mỗi layer có trọng số, tính ra `layer1_pct`, `layer2_pct`, `layer3_pct` (0–100%).

### 4.3. Composite Risk Score

* Tham số:

  * `Trong so Cang thanh khoan` (w_stress).
  * `Trong so Yield curve`, `Chenh lech QT`, `Spread`.

* Cách tính:

  * `risk_score` = tổng weight của các trụ đang “xấu”.
  * `risk_ratio = risk_score / max_score`.
  * `risk_pct = risk_ratio * 100%`.

* Màu nền:

  * 0% = xanh lá;
  * 0–25% = lime;
  * 25–50% = vàng;
  * 50–75% = cam;
  * > 75% = đỏ.

**Bucket B0–B4** được định nghĩa từ `risk_pct`:

* B0: 0–20
* B1: 20–40
* B2: 40–60
* B3: 60–80
* B4: 80–100

---

## 5. Policy Pressure Index & Research Guide (Pane 5)

### 5.1. Xây dựng Policy Pressure (0–100)

Bốn block thành phần:

1. **Funding pressure**

   * Chuẩn hóa từ Stress bằng Percentile / Robust Z / Hybrid.

2. **Curve pressure**

   * Trung bình của Curve risk + Spread risk.

3. **External pressure**

   * Kết hợp International diff và Fed gap (Fed – SBV)
   * Cho phép `Fed-sensitive mode` để weight External tăng lên khi Fed gap dương mạnh.

4. **FX pressure**

   * Biến động theo FX YoY, volatility 3M, z-score & percentile.
   * Có `fx_shock_mult` để “phóng đại” cú sốc FX.

Tổng hợp thành:

[
PolicyPressure = \frac{
FP·w_{fp} + CP·w_{cp} + EP·w_{ep} + FX·w_{fx}
}{
w_{fp}+w_{cp}+w_{ep}+w_{fx}
}
]

với FP,CP,EP,FX đều nằm trong 0–100.

### 5.2. Các zone chính sách

* `zone_low_pct` (mặc định 30%)
* `zone_high_pct` (mặc định 70%)

Diễn giải:

1. **Easing window (≤ zone_low)**

   * Áp lực tổng thấp → có dư địa giảm lãi suất / nới lỏng.

2. **Neutral window (zone_low – zone_high)**

   * Cân bằng nội–ngoại, chính sách nhiều khả năng **giữ lập trường**.

3. **Constraint window (≥ zone_high)**

   * Áp lực cao → khó cắt lãi suất, thậm chí phải **thắt chặt / phòng thủ**.

Bảng “Research Guide” hiển thị:

* Mức PolicyPressure hiện tại.
* Zone tương ứng và câu summary tiếng Việt.

### 5.3. Bảng Decomposition

Bảng trên cùng bên phải:

* Mỗi dòng: **Funding / Curve / External / FX**.
* Cột:

  * `Index %`: chỉ số riêng từng block (0–100).
  * `Weight`: trọng số đưa vào công thức.
  * `Contribution`: số điểm đóng góp vào PolicyPressure (tính theo `Index% * weight / tổng weight`).

Cách đọc:

* Nhìn **Index %** để biết block nào đang “căng”.
* Nhìn **Contribution** để biết block nào **góp bao nhiêu điểm** vào áp lực chung.

  * Ví dụ: Funding 100%, weight 0.35 → ~35 điểm trên PolicyPressure.

---

## 6. Macro Weather & Indices Research – Interpretation Guide

### 6.1. Panel 1 – Macro Weather

Bảng tóm tắt gồm:

1. Header:

   * `MACRO WEATHER – Bx | Risk y%`
   * Xem bức tranh tổng về bucket và mức risk hiện tại.

2. Hàng “Bucket hiện tại”

   * Cho biết B0–B4.

3. 4 hàng “Stress / Yield curve / Intl diff / Spread LS”

   * Trạng thái:

     * “BÌNH THƯỜNG / ỔN ĐỊNH” (màu xanh)
     * “CĂNG THẲNG / ĐẢO NGƯỢC / ÁP LỰC QT / HẸP/XẤU” (màu đỏ).

4. Hàng “VNINDEX (20 bars)”

   * `AvgR20` (trung bình lợi suất 20-bar khi ở bucket này).
   * `Win%` (tỷ lệ số lần R20 > 0).
   * `AvgDD20` (drawdown trung bình trong 20 ngày sau đó).

→ Dùng để trả lời câu hỏi:

> “Khi macro đang ở bucket B3 thì behaviour điển hình của VNINDEX trong 1 tháng tới là gì?”

### 6.2. Panel 2 – Market Regime Map (Table A)

* Mỗi dòng = 1 chỉ số HOSE.
* Cột:

  * `AvgR20`, `Win20%`: hành vi 1M.
  * `AvgR60`: hành vi 3M (nếu bật `calc_R60`).
  * `AvgDD20`: drawdown trung bình 20 ngày (nếu bật `calc_DD20`).
  * `N20`: số mẫu trong bucket (nếu nhỏ hơn `min_N_market` sẽ báo `N<min`).

→ Dùng để:

* So sánh **large cap vs mid/small cap** trong từng regime macro.
* Ví dụ: “Ở B3, Smallcap có AvgR20 âm mạnh và DD sâu hơn VN30?”.

### 6.3. Panel 3 – Sector Rotation Map (Table B)

* Tính **AvgRR20** = R20(sector) – R20(VNINDEX) trong mỗi bucket.
* Lọc các sector có `N ≥ min_N_sector`.
* Tạo 2 block:

  * **Top 3 outperform** (AvgRR20 cao nhất).
  * **Bottom 3 underperform** (AvgRR20 thấp nhất).

→ Dùng để:

* Trả lời:

  > “Khi macro ở B1 thì nhóm nào thường outperform VNINDEX?”
  > “Ở B3/B4, nhóm nào thường underperform mạnh nhất?”

### 6.4. Panel 4 – Transition Summary (Table C)

* Với horizon `L` (mặc định 20 bars):

  * Lấy bucket hiện tại b_now.
  * Tính từ lịch sử, khi từng ở bucket này, sau L ngày:

    * `p_up` = xác suất chuyển lên bucket cao hơn.
    * `p_same` = xác suất ở lại.
    * `p_down` = xác suất chuyển xuống.

* Đồng thời hiển thị số mẫu `N` cho mỗi hướng.

→ Dùng để:

* Đánh giá **tính bền vững** của regime hiện tại.
* Ví dụ: “Khi vào B4, lịch sử cho thấy ~60% khả năng trong 1 tháng tới rơi xuống bucket thấp hơn?”.

---

## 7. Workflow gợi ý cho nghiên cứu

1. **Bước 1 – Chọn Threshold Mode**

   * Giai đoạn đầu: dùng `Percentile-based` để thấy khung cảnh tổng quát.
   * Sau khi quen dữ liệu: thử `Dynamic (z-score)` để bám sát cú sốc.

2. **Bước 2 – Quan sát Macro (Pane 1–4)**

   * Pane 1: hiểu xu hướng lãi suất & đường cong.
   * Pane 2: xem spread/z-score để hiểu độ “dị” so với lịch sử.
   * Pane 3: nắm `risk_pct` và bucket hiện tại.
   * Pane 4: xem layer nào đang kéo rủi ro lên (Funding vs Cycle vs External).

3. **Bước 3 – Đọc Policy Pressure (Pane 5)**

   * Kiểm tra xem đang ở Easing / Neutral / Constraint.
   * Dùng bảng Decomposition để biết kênh nào gây áp lực chính: Funding, Curve, External, FX.

4. **Bước 4 – Kết nối với Equity panels**

   * Panel 1: Macro Weather → behaviour VNINDEX trong regime hiện tại.
   * Panel 2–3: Market & Sector maps → style & sector positioning theo bucket.
   * Panel 4: Transition Summary → bền vững của regime.

5. **Bước 5 – Ghi chú & cập nhật**

   * Khi có cú sốc mới (ví dụ Fed hike, biến động FX), kiểm tra:

     * Policy Pressure tăng do block nào?
     * Risk bucket chuyển từ B2 → B3/B4?
   * Từ đó update luận điểm research.

---

## 8. Hạn chế & lưu ý học thuật

1. **Phụ thuộc chất lượng dữ liệu TradingView**

   * Ticker VN02Y, VN10Y, VNINTR, VNINBR, USINTR phải đúng & liên tục.

2. **Không phải là mô hình nhân quả**

   * Các chỉ số risk & pressure là **mô tả thống kê**, không đảm bảo dự báo chắc chắn.

3. **Sample size**

   * Với bucket ít xuất hiện, `N` nhỏ → thống kê không ổn định.
   * Nên đặt `min_N_market`, `min_N_sector`, `min_N_trans` đủ cao (ví dụ ≥30).

4. **Không thay thế phân tích định tính**

   * Script hỗ trợ đọc nhanh “weather” vĩ mô, nhưng vẫn cần kết hợp:

     * Dữ liệu tín dụng, tăng trưởng, lạm phát, chính sách định tính.

---


