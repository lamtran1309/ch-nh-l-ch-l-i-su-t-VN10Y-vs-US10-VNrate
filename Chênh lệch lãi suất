//@version=5
indicator("Macro Alert System v4.3 - Academic Lite", shorttitle="MacroAcademic v4.3", overlay=false, max_labels_count=500, max_lines_count=500, max_bars_back=5000)

// =====================
// 0) HÃ€M PHá»¤ TRá»¢ NÃ‚NG Cáº¤P
// =====================

// HÃ m robust z-score vá»›i winsorization
f_robust_zscore(src, length, clip_multiplier) =>
    _mean = ta.sma(src, length)
    _std = ta.stdev(src, length)
    upper_bound = _mean + clip_multiplier * _std
    lower_bound = _mean - clip_multiplier * _std
    clipped_src = math.max(lower_bound, math.min(upper_bound, src))
    clipped_mean = ta.sma(clipped_src, length)
    clipped_std = ta.stdev(clipped_src, length)
    clipped_std > 0 ? (src - clipped_mean) / clipped_std : 0.0

// HÃ m tÃ­nh ngÆ°á»¡ng dá»±a trÃªn percentile
f_percentile_threshold(src, length, percentile_val) =>
    ta.percentile_linear_interpolation(src, length, percentile_val)

// HÃ m kiá»ƒm tra tÃ­n hiá»‡u dá»±a trÃªn percentile
f_check_percentile_warning(src, length, percentile_val, is_low_bad) =>
    threshold_val = f_percentile_threshold(src, length, percentile_val)
    is_low_bad ? src <= threshold_val : src >= threshold_val

f_statusColor(s) =>
    color c = color.new(color.green, 0)
    if s == "CANG THANG" or s == "DAO NGUOC" or s == "AP LUC FX"
        c := color.new(color.red, 0)
    else if s == "THAP"
        c := color.new(color.orange, 0)
    c

f_layerColor(pct) =>
    color c = color.new(color.green, 0)
    if pct >= 80
        c := color.new(color.red, 0)
    else if pct >= 60
        c := color.new(color.orange, 0)
    else if pct >= 40
        c := color.new(color.yellow, 0)
    else if pct >= 20
        c := color.new(color.lime, 0)
    else
        c := color.new(color.green, 0)
    c

f_textColorForBg(bg) =>
    bg == color.new(color.yellow, 0) ? color.black : color.white

// Helper gáº¯n nhÃ£n cho Ä‘Æ°á»ng táº¡i bar cuá»‘i
f_markLine(lbl, txt, y, c) =>
    label _lbl = lbl
    if barstate.islast
        if not na(y)
            if na(_lbl)
                _lbl := label.new(bar_index, y, txt, style=label.style_label_left, textcolor=c, color=color.new(color.black, 90), size=size.tiny)
            label.set_x(_lbl, bar_index)
            label.set_y(_lbl, y)
            label.set_text(_lbl, txt)
            label.set_textcolor(_lbl, c)
            label.set_color(_lbl, color.new(color.black, 90))
        else
            if not na(_lbl)
                label.delete(_lbl)
            _lbl := na
    _lbl

// NhÃ£n (Ä‘Æ°á»£c cáº­p nháº­t báº±ng f_markLine)
var label l_p1_10y = na
var label l_p1_2y = na
var label l_p1_ib = na
var label l_p1_policy = na
var label l_p1_us10y = na
var label l_p1_zero = na

var label l_p2_s = na
var label l_p2_c = na
var label l_p2_i = na
var label l_p2_ls = na
var label l_p2_zero = na

var label l_p4_l1 = na
var label l_p4_l2 = na
var label l_p4_l3 = na
var label l_p4_r80 = na
var label l_p4_r60 = na
var label l_p4_r40 = na
var label l_p4_r20 = na

// =====================
// 1) CHáº¾ Äá»˜ HIá»‚N THá»Š
// =====================
view_mode = input.string("Pane 1 - Lai suat & chinh sach", "Che do hien thi", options = ["Pane 1 - Lai suat & chinh sach", "Pane 2 - Spreads & z-score", "Pane 3 - Risk score & Dashboard", "Pane 4 - 3-Layer Risk Analysis"])

show_pane1 = view_mode == "Pane 1 - Lai suat & chinh sach"
show_pane2 = view_mode == "Pane 2 - Spreads & z-score"
show_pane3 = view_mode == "Pane 3 - Risk score & Dashboard"
show_pane4 = view_mode == "Pane 4 - 3-Layer Risk Analysis"

// =====================
// 2) NHáº¬P Dá»® LIá»†U
// =====================
policy_rate = request.security("VNINTR", timeframe.period, close, barmerge.gaps_off, barmerge.lookahead_off)
bond_2y = request.security("VN02Y", timeframe.period, close, barmerge.gaps_off, barmerge.lookahead_off)
bond_10y = request.security("VN10Y", timeframe.period, close, barmerge.gaps_off, barmerge.lookahead_off)
us_10y = request.security("US10Y", timeframe.period, close, barmerge.gaps_off, barmerge.lookahead_off)
interbank_rate = request.security("VNINBR", timeframe.period, close, barmerge.gaps_off, barmerge.lookahead_off)

// =====================
// 3) SPREADS
// =====================
liquidity_stress = interbank_rate - policy_rate
yield_curve_standard = bond_10y - bond_2y
intl_yield_diff = bond_10y - us_10y
long_short_spread = bond_10y - policy_rate

// =====================
// 4) NGÆ¯á» NG Dá»°A TRÃŠN PERCENTILE
// =====================
threshold_mode = input.string("Percentile-based", "Che do nguong", options = ["Static", "Dynamic (z-score)", "Percentile-based"])

percentile_lookback = input.int(504, "Chu ky phan phoi (bars)", minval=100, maxval=2000)

stress_percentile = input.int(85, "Stress % (cao = xau)", minval=50, maxval=99)
curve_percentile = input.int(15, "Curve % (thap = xau)", minval=1, maxval=50)
intl_percentile = input.int(15, "Intl diff % (thap = xau)", minval=1, maxval=50)
spread_percentile = input.int(15, "Spread % (thap = xau)", minval=1, maxval=50)

len_stats = input.int(252, "Chu ky thong ke (z-score)", minval=60)
clip_multiplier = input.float(2.5, "Clip outliers (std)", minval=1.5, maxval=4.0, step=0.1)

stress_threshold = input.float(1.5, "[Static] Cang thanh khoan", step=0.1)
curve_threshold = input.float(0.0, "[Static] Dao nguoc (10Y-2Y)", step=0.1)
intl_threshold = input.float(2.0, "[Static] Chenh lech QT", step=0.1)
spread_threshold = input.float(3.0, "[Static] Spread ngan-dai", step=0.1)

// TÃ­nh percentile thresholds
stress_percentile_val = f_percentile_threshold(liquidity_stress, percentile_lookback, stress_percentile)
curve_percentile_val = f_percentile_threshold(yield_curve_standard, percentile_lookback, curve_percentile)
intl_percentile_val = f_percentile_threshold(intl_yield_diff, percentile_lookback, intl_percentile)
spread_percentile_val = f_percentile_threshold(long_short_spread, percentile_lookback, spread_percentile)

// TÃ­nh robust z-scores
stress_z_robust = f_robust_zscore(liquidity_stress, len_stats, clip_multiplier)
curve_z_robust = f_robust_zscore(yield_curve_standard, len_stats, clip_multiplier)
intl_z_robust = f_robust_zscore(intl_yield_diff, len_stats, clip_multiplier)
spread_z_robust = f_robust_zscore(long_short_spread, len_stats, clip_multiplier)

use_percentile = threshold_mode == "Percentile-based"
use_dynamic = threshold_mode == "Dynamic (z-score)"
use_static = threshold_mode == "Static"

// =====================
// 5) TÃN HIá»†U 4 TRá»¤
// =====================
bool stress_high = false
bool curve_inversion = false
bool intl_warning = false
bool spread_warning = false

if use_percentile
    stress_high := f_check_percentile_warning(liquidity_stress, percentile_lookback, stress_percentile, false)
    curve_inversion := f_check_percentile_warning(yield_curve_standard, percentile_lookback, curve_percentile, true)
    intl_warning := f_check_percentile_warning(intl_yield_diff, percentile_lookback, intl_percentile, true)
    spread_warning := f_check_percentile_warning(long_short_spread, percentile_lookback, spread_percentile, true)
else if use_dynamic
    z_stress_threshold = input.float(1.0, "[Z-score] Stress threshold", step=0.1)
    z_curve_threshold = input.float(-1.0, "[Z-score] Curve threshold", step=0.1)
    z_intl_threshold = input.float(-1.0, "[Z-score] Intl threshold", step=0.1)
    z_spread_threshold = input.float(-1.0, "[Z-score] Spread threshold", step=0.1)
    
    stress_high := stress_z_robust > z_stress_threshold
    curve_inversion := curve_z_robust < z_curve_threshold
    intl_warning := intl_z_robust < z_intl_threshold
    spread_warning := spread_z_robust < z_spread_threshold
else
    stress_high := liquidity_stress > stress_threshold
    curve_inversion := yield_curve_standard < curve_threshold
    intl_warning := intl_yield_diff < intl_threshold
    spread_warning := long_short_spread < spread_threshold

// =====================
// 6) PHÃ‚N TÃCH 3 Lá»šP Rá»¦I RO
// =====================
layer1_weight_stress = input.int(3, "ðŸŸ¥ Lop 1: Trong so Cang thanh khoan", minval=1, maxval=5)

layer1_score = 0.0
layer1_score := stress_high ? layer1_weight_stress : 0
layer1_max = layer1_weight_stress
layer1_pct = layer1_max > 0 ? (layer1_score / layer1_max) * 100 : 0.0

layer2_weight_curve_macro = input.int(3, "ðŸŸ¨ Lop 2: Trong so Yield curve (10Y-2Y)", minval=1, maxval=5)
layer2_weight_spread = input.int(2, "ðŸŸ¨ Lop 2: Trong so Spread ngan-dai", minval=1, maxval=5)

layer2_score = 0.0
layer2_score := (curve_inversion ? layer2_weight_curve_macro : 0) + (spread_warning ? layer2_weight_spread : 0)
layer2_max = layer2_weight_curve_macro + layer2_weight_spread
layer2_pct = layer2_max > 0 ? (layer2_score / layer2_max) * 100 : 0.0

layer3_weight_intl = input.int(2, "ðŸŸ¦ Lop 3: Trong so Chenh lech QT", minval=1, maxval=5)
layer3_weight_fx = input.int(1, "ðŸŸ¦ Lop 3: Trong so FX pressure", minval=1, maxval=5)

layer3_score = 0.0
layer3_score := (intl_warning ? layer3_weight_intl : 0) + (stress_high and intl_warning ? layer3_weight_fx : 0)
layer3_max = layer3_weight_intl + layer3_weight_fx
layer3_pct = layer3_max > 0 ? (layer3_score / layer3_max) * 100 : 0.0

// NgÆ°á»¡ng cáº£nh bÃ¡o cho tá»«ng lá»›p (dÃ¹ng á»Ÿ Pane 4 vÃ  há»‡ thá»‘ng alert)
layer1_alert = input.float(60, "Nguong canh bao Lop 1 (%)", minval=0, maxval=100)
layer2_alert = input.float(60, "Nguong canh bao Lop 2 (%)", minval=0, maxval=100)
layer3_alert = input.float(60, "Nguong canh bao Lop 3 (%)", minval=0, maxval=100)

// =====================
// 7) RISK SCORE Tá»”NG Há»¢P
// =====================
w_stress = input.int(2, "Trong so Cang thanh khoan")
w_curve = input.int(2, "Trong so Yield curve (10Y-2Y)")
w_intl = input.int(1, "Trong so Chenh lech QT")
w_spread = input.int(1, "Trong so Spread ngan-dai")

int risk_score = 0
risk_score := 0
if stress_high
    risk_score += w_stress
if curve_inversion
    risk_score += w_curve
if intl_warning
    risk_score += w_intl
if spread_warning
    risk_score += w_spread

max_score = w_stress + w_curve + w_intl + w_spread
risk_ratio = max_score > 0 ? risk_score / max_score : 0.0
risk_pct_value = risk_ratio * 100.0

color risk_base = risk_ratio == 0 ? color.new(color.green, 0) : risk_ratio <= 0.25 ? color.new(color.lime, 0) : risk_ratio <= 0.5 ? color.new(color.yellow, 0) : risk_ratio <= 0.75 ? color.new(color.orange, 0) : color.new(color.red, 0)

color risk_bg = color.new(risk_base, 92)
color risk_fill = color.new(risk_base, 85)

// =====================
// 8) PANE 1 â€“ LÃƒI SUáº¤T & CHÃNH SÃCH
// =====================
pane1_line1 = show_pane1 ? bond_10y : na
pane1_line2 = show_pane1 ? bond_2y : na
pane1_line3 = show_pane1 ? interbank_rate : na
pane1_line4 = show_pane1 ? policy_rate : na
pane1_line5 = show_pane1 ? us_10y : na
pane1_zero_line = show_pane1 ? 0 : na

plot(pane1_line1, title="VN10Y", color=color.new(color.orange, 0), linewidth=2)
plot(pane1_line2, title="VN02Y", color=color.new(color.purple, 0), linewidth=2)
plot(pane1_line3, title="VN Interbank", color=color.new(color.teal, 0), linewidth=2)
plot(pane1_line4, title="SBV Policy", color=color.new(color.red, 0), linewidth=2)
plot(pane1_line5, title="US10Y", color=color.new(color.blue, 40), linewidth=1)
plot(pane1_zero_line, title="0", color=color.new(color.gray, 80), linewidth=1)

// NhÃ£n Pane 1
l_p1_10y    := f_markLine(l_p1_10y, "VN10Y", pane1_line1, color.orange)
l_p1_2y     := f_markLine(l_p1_2y, "VN02Y", pane1_line2, color.purple)
l_p1_ib     := f_markLine(l_p1_ib, "Interbank", pane1_line3, color.teal)
l_p1_policy := f_markLine(l_p1_policy, "Policy", pane1_line4, color.red)
l_p1_us10y  := f_markLine(l_p1_us10y, "US10Y", pane1_line5, color.blue)
l_p1_zero   := f_markLine(l_p1_zero, "0 line", pane1_zero_line, color.gray)

// =====================
// 9) PANE 2 â€“ SPREADS / Z-SCORE
// =====================
pane2_view = input.string("Spreads", "Pane 2: Hien thi", options=["Spreads", "Z-scores", "Percentile-thresholds", "Robust Z-scores"])

p2_l1 = pane2_view == "Spreads" ? liquidity_stress : pane2_view == "Z-scores" ? stress_z_robust : pane2_view == "Robust Z-scores" ? stress_z_robust : pane2_view == "Percentile-thresholds" ? liquidity_stress - stress_percentile_val : na
p2_l2 = pane2_view == "Spreads" ? yield_curve_standard : pane2_view == "Z-scores" ? curve_z_robust : pane2_view == "Robust Z-scores" ? curve_z_robust : pane2_view == "Percentile-thresholds" ? yield_curve_standard - curve_percentile_val : na
p2_l3 = pane2_view == "Spreads" ? intl_yield_diff : pane2_view == "Z-scores" ? intl_z_robust : pane2_view == "Robust Z-scores" ? intl_z_robust : pane2_view == "Percentile-thresholds" ? intl_yield_diff - intl_percentile_val : na
p2_l4 = pane2_view == "Spreads" ? long_short_spread : pane2_view == "Z-scores" ? spread_z_robust : pane2_view == "Robust Z-scores" ? spread_z_robust : pane2_view == "Percentile-thresholds" ? long_short_spread - spread_percentile_val : na

p2_display1 = show_pane2 ? p2_l1 : na
p2_display2 = show_pane2 ? p2_l2 : na
p2_display3 = show_pane2 ? p2_l3 : na
p2_display4 = show_pane2 ? p2_l4 : na
p2_zero_line = show_pane2 ? 0 : na

plot(p2_display1, title="Stress Line", color=color.new(#FF6B6B, 0), linewidth=2)
plot(p2_display2, title="Curve Line", color=color.new(#4ECDC4, 0), linewidth=2)
plot(p2_display3, title="Intl Line", color=color.new(#45B7D1, 0), linewidth=2)
plot(p2_display4, title="Spread Line", color=color.new(#96CEB4, 0), linewidth=2)
plot(p2_zero_line, title="0", color=color.new(color.gray, 80), linewidth=1)

// NhÃ£n Pane 2
l_p2_s    := f_markLine(l_p2_s, "Stress", p2_display1, color.new(#FF6B6B, 0))
l_p2_c    := f_markLine(l_p2_c, "Curve", p2_display2, color.new(#4ECDC4, 0))
l_p2_i    := f_markLine(l_p2_i, "Intl diff", p2_display3, color.new(#45B7D1, 0))
l_p2_ls   := f_markLine(l_p2_ls, "Long-short", p2_display4, color.new(#96CEB4, 0))
l_p2_zero := f_markLine(l_p2_zero, "0 line", p2_zero_line, color.gray)

// =====================
// 10) Ká»ŠCH Báº¢N VÄ¨ MÃ”
// =====================
liquidity_crisis = stress_high and curve_inversion and intl_warning
recession_warning = curve_inversion and spread_warning
fx_pressure = intl_warning and stress_high
inflation_proxy = long_short_spread > spread_percentile_val * 1.5 and yield_curve_standard > 0

// =====================
// 11) PANE 3 â€“ RISK SCORE & DASHBOARD
// =====================
p3_risk = show_pane3 ? risk_pct_value : na
plot(p3_risk, title="Risk % (0-100)", color=color.new(color.white, 0), linewidth=2, style=plot.style_stepline)
plot(p3_risk, title="Risk fill", style=plot.style_area, color=show_pane3 ? risk_fill : na)
bgcolor(show_pane3 ? risk_bg : na, title="Risk background")

var table risk_table = na
var table dashboard = na
var table calibration_table = na
var table layer_table = na

current_stress_pct_val = ta.percentrank(liquidity_stress, percentile_lookback)
current_curve_pct_val = ta.percentrank(yield_curve_standard, percentile_lookback)
current_intl_pct_val = ta.percentrank(intl_yield_diff, percentile_lookback)
current_spread_pct_val = ta.percentrank(long_short_spread, percentile_lookback)

// Cáº­p nháº­t báº£ng theo tá»«ng pane Ä‘á»ƒ trÃ¡nh nhá»“i nhÃ©t vÃ o Pane 3
if barstate.islast
    // Pane 2: Calibration + percentile
    if show_pane2
        if not na(calibration_table)
            table.delete(calibration_table)
        calibration_table := table.new(position.middle_right, 4, 9, bgcolor=color.new(#1A237E, 95), border_width=1, border_color=color.new(color.white, 30))
        
        table.merge_cells(calibration_table, 0, 0, 3, 0)
        table.cell(calibration_table, 0, 0, " ðŸ“Š CALIBRATION & SIGN CONVENTION ", bgcolor=color.new(#0D47A1, 0), text_color=color.white, text_size=size.normal)
        
        table.cell(calibration_table, 0, 1, " Indicator ", bgcolor=color.new(#3949AB, 0), text_color=color.white)
        table.cell(calibration_table, 1, 1, " Sign ", bgcolor=color.new(#3949AB, 0), text_color=color.white)
        table.cell(calibration_table, 2, 1, " Current ", bgcolor=color.new(#3949AB, 0), text_color=color.white)
        table.cell(calibration_table, 3, 1, " Threshold ", bgcolor=color.new(#3949AB, 0), text_color=color.white)
        
        sign1 = "CAO = Xáº¤U"
        table.cell(calibration_table, 0, 2, " Liquidity Stress ", bgcolor=color.new(#FF5252, 20), text_color=color.white)
        table.cell(calibration_table, 1, 2, " " + sign1 + " ", bgcolor=color.new(#FF5252, 20), text_color=color.white)
        table.cell(calibration_table, 2, 2, " " + str.tostring(liquidity_stress, "#.##") + " ", bgcolor=color.new(#FF5252, 20), text_color=color.white)
        
        threshold1 = use_percentile ? str.tostring(stress_percentile_val, "#.##") + " (" + str.tostring(stress_percentile) + "th %)" : use_dynamic ? "Z > " + str.tostring(1.0, "#.#") : str.tostring(stress_threshold, "#.##")
        table.cell(calibration_table, 3, 2, " " + threshold1 + " ", bgcolor=stress_high ? color.red : color.green, text_color=color.white)
        
        sign2 = "THáº¤P = Xáº¤U"
        table.cell(calibration_table, 0, 3, " Yield Curve ", bgcolor=color.new(#4ECDC4, 20), text_color=color.white)
        table.cell(calibration_table, 1, 3, " " + sign2 + " ", bgcolor=color.new(#4ECDC4, 20), text_color=color.white)
        table.cell(calibration_table, 2, 3, " " + str.tostring(yield_curve_standard, "#.##") + " ", bgcolor=color.new(#4ECDC4, 20), text_color=color.white)
        
        threshold2 = use_percentile ? str.tostring(curve_percentile_val, "#.##") + " (" + str.tostring(curve_percentile) + "th %)" : use_dynamic ? "Z < " + str.tostring(-1.0, "#.#") : str.tostring(curve_threshold, "#.##")
        table.cell(calibration_table, 3, 3, " " + threshold2 + " ", bgcolor=curve_inversion ? color.red : color.green, text_color=color.white)
        
        sign3 = "THáº¤P = Xáº¤U"
        table.cell(calibration_table, 0, 4, " Intl Diff ", bgcolor=color.new(#45B7D1, 20), text_color=color.white)
        table.cell(calibration_table, 1, 4, " " + sign3 + " ", bgcolor=color.new(#45B7D1, 20), text_color=color.white)
        table.cell(calibration_table, 2, 4, " " + str.tostring(intl_yield_diff, "#.##") + " ", bgcolor=color.new(#45B7D1, 20), text_color=color.white)
        
        threshold3 = use_percentile ? str.tostring(intl_percentile_val, "#.##") + " (" + str.tostring(intl_percentile) + "th %)" : use_dynamic ? "Z < " + str.tostring(-1.0, "#.#") : str.tostring(intl_threshold, "#.##")
        table.cell(calibration_table, 3, 4, " " + threshold3 + " ", bgcolor=intl_warning ? color.red : color.green, text_color=color.white)
        
        sign4 = "THáº¤P = Xáº¤U"
        table.cell(calibration_table, 0, 5, " Long-Short ", bgcolor=color.new(#96CEB4, 20), text_color=color.white)
        table.cell(calibration_table, 1, 5, " " + sign4 + " ", bgcolor=color.new(#96CEB4, 20), text_color=color.white)
        table.cell(calibration_table, 2, 5, " " + str.tostring(long_short_spread, "#.##") + " ", bgcolor=color.new(#96CEB4, 20), text_color=color.white)
        
        threshold4 = use_percentile ? str.tostring(spread_percentile_val, "#.##") + " (" + str.tostring(spread_percentile) + "th %)" : use_dynamic ? "Z < " + str.tostring(-1.0, "#.#") : str.tostring(spread_threshold, "#.##")
        table.cell(calibration_table, 3, 5, " " + threshold4 + " ", bgcolor=spread_warning ? color.red : color.green, text_color=color.white)
        
        table.merge_cells(calibration_table, 0, 6, 3, 6)
        table.cell(calibration_table, 0, 6, " ðŸ“ˆ CURRENT PERCENTILE RANKING ", bgcolor=color.new(#546E7A, 50), text_color=color.white)
        
        table.cell(calibration_table, 0, 7, " Stress: ", bgcolor=color.new(#FF5252, 10), text_color=color.white)
        table.cell(calibration_table, 1, 7, str.tostring(current_stress_pct_val, "#.#") + "%", bgcolor=f_layerColor(current_stress_pct_val), text_color=color.white)
        
        table.cell(calibration_table, 2, 7, " Curve: ", bgcolor=color.new(#4ECDC4, 10), text_color=color.white)
        table.cell(calibration_table, 3, 7, str.tostring(current_curve_pct_val, "#.#") + "%", bgcolor=f_layerColor(100-current_curve_pct_val), text_color=color.white)
        
        table.cell(calibration_table, 0, 8, " Intl: ", bgcolor=color.new(#45B7D1, 10), text_color=color.white)
        table.cell(calibration_table, 1, 8, str.tostring(current_intl_pct_val, "#.#") + "%", bgcolor=f_layerColor(100-current_intl_pct_val), text_color=color.white)
        
        table.cell(calibration_table, 2, 8, " Spread: ", bgcolor=color.new(#96CEB4, 10), text_color=color.white)
        table.cell(calibration_table, 3, 8, str.tostring(current_spread_pct_val, "#.#") + "%", bgcolor=f_layerColor(100-current_spread_pct_val), text_color=color.white)
    else
        if not na(calibration_table)
            table.delete(calibration_table)
        calibration_table := na

    // Pane 3: Risk table + Dashboard
    if show_pane3
        if not na(risk_table)
            table.delete(risk_table)
        if not na(dashboard)
            table.delete(dashboard)
        
        risk_table := table.new(position.top_right, 2, 7, bgcolor=color.new(color.black, 25), border_width=2, border_color=color.new(color.white, 20))
        dashboard := table.new(position.bottom_right, 3, 7, bgcolor=color.new(color.black, 10), border_width=2, border_color=color.new(color.white, 20))
        
        table.merge_cells(risk_table, 0, 0, 1, 0)
        table.cell(risk_table, 0, 0, " HE THONG CANH BAO VI MO ", bgcolor=color.new(color.blue, 0), text_color=color.white, text_size=size.normal)
        
        table.merge_cells(risk_table, 0, 1, 1, 1)
        table.cell(risk_table, 0, 1, "âœ“ Academic Lite v4.3", bgcolor=color.new(#4CAF50, 30), text_color=color.white, text_size=size.tiny)

        table.cell(risk_table, 0, 2, " Cang TK ", bgcolor=stress_high ? color.red : color.green, text_color=color.white, text_size=size.small)
        table.cell(risk_table, 0, 3, " Yield curve ", bgcolor=curve_inversion ? color.red : color.green, text_color=color.white, text_size=size.small)
        table.cell(risk_table, 0, 4, " Intl diff ", bgcolor=intl_warning ? color.red : color.green, text_color=color.white, text_size=size.small)
        table.cell(risk_table, 0, 5, " Long-short ", bgcolor=spread_warning ? color.red : color.green, text_color=color.white, text_size=size.small)

        table.cell(risk_table, 1, 2, stress_high ? " CAO " : " ON ", bgcolor=stress_high ? color.red : color.green, text_color=color.white, text_size=size.small)
        table.cell(risk_table, 1, 3, curve_inversion ? " DAO " : " ON ", bgcolor=curve_inversion ? color.red : color.green, text_color=color.white, text_size=size.small)
        table.cell(risk_table, 1, 4, intl_warning ? " THAP " : " ON ", bgcolor=intl_warning ? color.red : color.green, text_color=color.white, text_size=size.small)
        table.cell(risk_table, 1, 5, spread_warning ? " THAP " : " ON ", bgcolor=spread_warning ? color.red : color.green, text_color=color.white, text_size=size.small)
        
        table.cell(risk_table, 0, 6, " Risk Score ", bgcolor=color.new(color.black, 30), text_color=color.white, text_size=size.small)
        table.cell(risk_table, 1, 6, str.tostring(risk_score) + "/" + str.tostring(max_score), bgcolor=risk_base, text_color=color.white, text_size=size.small)

        table.merge_cells(dashboard, 0, 0, 2, 0)
        table.cell(dashboard, 0, 0, " DASHBOARD VI MO ", bgcolor=color.new(color.blue, 0), text_color=color.white, text_size=size.normal)

        table.cell(dashboard, 0, 1, " Chi bao ", bgcolor=color.new(color.white, 5), text_color=color.black, text_size=size.small)
        table.cell(dashboard, 1, 1, " Gia tri ", bgcolor=color.new(color.white, 5), text_color=color.black, text_size=size.small)
        table.cell(dashboard, 2, 1, " Trang thai ", bgcolor=color.new(color.white, 5), text_color=color.black, text_size=size.small)

        st1 = stress_high ? "CANG THANG" : "ON"
        st2 = curve_inversion ? "DAO NGUOC" : "ON"
        st3 = intl_warning ? "AP LUC FX" : "AN TOAN"
        st4 = spread_warning ? "THAP" : "CAO"

        table.cell(dashboard, 0, 2, " Liquidity stress\n(IB-Policy) ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 1, 2, " " + str.tostring(liquidity_stress, "#.##") + " ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 2, 2, " " + st1 + " ", bgcolor=f_statusColor(st1), text_color=color.white, text_size=size.small)

        table.cell(dashboard, 0, 3, " Yield curve\n(10Y-2Y) ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 1, 3, " " + str.tostring(yield_curve_standard, "#.##") + " ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 2, 3, " " + st2 + " ", bgcolor=f_statusColor(st2), text_color=color.white, text_size=size.small)

        table.cell(dashboard, 0, 4, " Intl yield diff\n(VN10Y-US10Y) ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 1, 4, " " + str.tostring(intl_yield_diff, "#.##") + " ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 2, 4, " " + st3 + " ", bgcolor=f_statusColor(st3), text_color=color.white, text_size=size.small)

        table.cell(dashboard, 0, 5, " Long-short spread\n(10Y-Policy) ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 1, 5, " " + str.tostring(long_short_spread, "#.##") + " ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 2, 5, " " + st4 + " ", bgcolor=f_statusColor(st4), text_color=color.white, text_size=size.small)

        scen = "BINH THUONG"
        scol = color.new(color.green, 0)
        if liquidity_crisis
            scen := "KHUNG HOANG THANH KHOAN"
            scol := color.new(color.red, 0)
        else if recession_warning
            scen := "CANH BAO SUY THOAI"
            scol := color.new(color.orange, 0)
        else if fx_pressure
            scen := "AP LUC TY GIA"
            scol := color.new(color.purple, 0)
        else if inflation_proxy
            scen := "PROXY LAM PHAT CAO"
            scol := color.new(color.yellow, 0)

        table.cell(dashboard, 0, 6, " KICH BAN: ", bgcolor=color.new(color.white, 5), text_color=color.black, text_size=size.small)
        table.merge_cells(dashboard, 1, 6, 2, 6)
        table.cell(dashboard, 1, 6, " " + scen + " ", bgcolor=scol, text_color=f_textColorForBg(scol), text_size=size.small)
    else
        if not na(risk_table)
            table.delete(risk_table)
        risk_table := na
        if not na(dashboard)
            table.delete(dashboard)
        dashboard := na

    // Pane 4: Layer summary
    if show_pane4
        if not na(layer_table)
            table.delete(layer_table)
        layer_table := table.new(position.top_right, 3, 5, bgcolor=color.new(color.black, 15), border_width=2, border_color=color.new(color.white, 20))
        table.merge_cells(layer_table, 0, 0, 2, 0)
        table.cell(layer_table, 0, 0, "3-Layer Summary", bgcolor=color.new(color.blue, 10), text_color=color.white, text_size=size.normal)
        table.cell(layer_table, 0, 1, "Layer", bgcolor=color.new(color.white, 5), text_color=color.black, text_size=size.small)
        table.cell(layer_table, 1, 1, "%", bgcolor=color.new(color.white, 5), text_color=color.black, text_size=size.small)
        table.cell(layer_table, 2, 1, "Alert", bgcolor=color.new(color.white, 5), text_color=color.black, text_size=size.small)

        status1 = layer1_pct >= layer1_alert ? "ALERT" : "OK"
        status2 = layer2_pct >= layer2_alert ? "ALERT" : "OK"
        status3 = layer3_pct >= layer3_alert ? "ALERT" : "OK"

        table.cell(layer_table, 0, 2, "Lá»›p 1: Thanh khoáº£n", bgcolor=color.new(#FF6B6B, 15), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 1, 2, str.tostring(layer1_pct, "#.#") + "%", bgcolor=f_layerColor(layer1_pct), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 2, 2, status1, bgcolor=layer1_pct >= layer1_alert ? color.red : color.new(color.green, 0), text_color=color.white, text_size=size.small)

        table.cell(layer_table, 0, 3, "Lá»›p 2: Chu ká»³ vÄ© mÃ´", bgcolor=color.new(#FFA726, 15), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 1, 3, str.tostring(layer2_pct, "#.#") + "%", bgcolor=f_layerColor(layer2_pct), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 2, 3, status2, bgcolor=layer2_pct >= layer2_alert ? color.red : color.new(color.green, 0), text_color=color.white, text_size=size.small)

        table.cell(layer_table, 0, 4, "Lá»›p 3: Ngoáº¡i vi/FX", bgcolor=color.new(#42A5F5, 15), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 1, 4, str.tostring(layer3_pct, "#.#") + "%", bgcolor=f_layerColor(layer3_pct), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 2, 4, status3, bgcolor=layer3_pct >= layer3_alert ? color.red : color.new(color.green, 0), text_color=color.white, text_size=size.small)
    else
        if not na(layer_table)
            table.delete(layer_table)
        layer_table := na

// =====================
// 12) PANE 4 â€“ 3-LAYER RISK ANALYSIS
// =====================
p4_l1 = show_pane4 ? layer1_pct : na
p4_l2 = show_pane4 ? layer2_pct : na
p4_l3 = show_pane4 ? layer3_pct : na

p4_ref80 = show_pane4 ? 80 : na
p4_ref60 = show_pane4 ? 60 : na
p4_ref40 = show_pane4 ? 40 : na
p4_ref20 = show_pane4 ? 20 : na

plot(p4_l1, title="ðŸŸ¥ Lá»›p 1: Rá»§i ro Thanh khoáº£n", color=color.new(#FF6B6B, 0), linewidth=3)
plot(p4_l2, title="ðŸŸ¨ Lá»›p 2: Rá»§i ro Chu ká»³ vÄ© mÃ´", color=color.new(#FFA726, 0), linewidth=3)
plot(p4_l3, title="ðŸŸ¦ Lá»›p 3: Rá»§i ro Ngoáº¡i vi", color=color.new(#42A5F5, 0), linewidth=3)

plot(p4_ref80, title="Ráº¥t Cao (80%)", color=color.new(color.red, 50), linewidth=1)
plot(p4_ref60, title="Cao (60%)", color=color.new(color.orange, 50), linewidth=1)
plot(p4_ref40, title="Trung bÃ¬nh (40%)", color=color.new(color.yellow, 50), linewidth=1)
plot(p4_ref20, title="Tháº¥p (20%)", color=color.new(color.green, 50), linewidth=1)

// NhÃ£n Pane 4
l_p4_l1  := f_markLine(l_p4_l1, "Lá»›p 1", p4_l1, color.new(#FF6B6B, 0))
l_p4_l2  := f_markLine(l_p4_l2, "Lá»›p 2", p4_l2, color.new(#FFA726, 0))
l_p4_l3  := f_markLine(l_p4_l3, "Lá»›p 3", p4_l3, color.new(#42A5F5, 0))
l_p4_r80 := f_markLine(l_p4_r80, "80% Ráº¥t cao", p4_ref80, color.red)
l_p4_r60 := f_markLine(l_p4_r60, "60% Cao", p4_ref60, color.orange)
l_p4_r40 := f_markLine(l_p4_r40, "40% TB", p4_ref40, color.yellow)
l_p4_r20 := f_markLine(l_p4_r20, "20% Tháº¥p", p4_ref20, color.green)

// =====================
// 13) ALERT SYSTEM
// =====================
risk_alert_level = input.int(4, "Nguong canh bao diem rui ro", minval=1)

if barstate.islast
    if layer1_pct >= layer1_alert
        alert("CANH BAO LOP 1: Rui ro thanh khoan = " + str.tostring(layer1_pct, "#.0") + "%", alert.freq_once_per_bar)
    
    if layer2_pct >= layer2_alert
        alert("CANH BAO LOP 2: Rui ro chu ky = " + str.tostring(layer2_pct, "#.0") + "%", alert.freq_once_per_bar)
    
    if layer3_pct >= layer3_alert
        alert("CANH BAO LOP 3: Rui ro ngoai vi = " + str.tostring(layer3_pct, "#.0") + "%", alert.freq_once_per_bar)
    
    if risk_score >= risk_alert_level
        alert("CANH BAO TONG: Diem rui ro = " + str.tostring(risk_score) + "/" + str.tostring(max_score), alert.freq_once_per_bar)
    
    if liquidity_crisis
        alert("CANH BAO KHAN: Khung hoang thanh khoan", alert.freq_once_per_bar)
