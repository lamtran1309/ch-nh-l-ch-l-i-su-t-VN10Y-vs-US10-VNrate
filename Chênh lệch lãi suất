//@version=5
indicator("Macro Alert System v4.2.0 - Academic w/ Panel-specific Tables",
     shorttitle="MacroAcademic v4.2.0", overlay=false, max_labels_count=500, max_lines_count=500)

// =====================
// 0) HÃ€M PHá»¤ TRá»¢
// =====================
f_zscore(src, length) =>
    _mean = ta.sma(src, length)
    _std  = ta.stdev(src, length)
    _std > 0 ? (src - _mean) / _std : 0.0

f_statusColor(s) =>
    color c = color.new(color.green, 0)
    if s == "CANG THANG" or s == "DAO NGUOC" or s == "AP LUC FX"
        c := color.new(color.red, 0)
    else if s == "THAP"
        c := color.new(color.orange, 0)
    c

f_layerColor(pct) =>
    color c = color.new(color.green, 0)
    if pct >= 80
        c := color.new(color.red, 0)
    else if pct >= 60
        c := color.new(color.orange, 0)
    else if pct >= 40
        c := color.new(color.yellow, 0)
    else if pct >= 20
        c := color.new(color.lime, 0)
    else
        c := color.new(color.green, 0)
    c

f_textColorForBg(bg) =>
    bg == color.new(color.yellow, 0) ? color.black : color.white

f_delLabel(l) =>
    if not na(l)
        label.delete(l)

// =====================
// 1) CHáº¾ Äá»˜ HIá»‚N THá»Š (3 PANEL + LAYERS)
// =====================
view_mode = input.string(
     "Pane 1 - Lai suat & chinh sach",
     "Che do hien thi",
     options = [
         "Pane 1 - Lai suat & chinh sach",
         "Pane 2 - Spreads & z-score", 
         "Pane 3 - Risk score & Dashboard",
         "Pane 4 - 3-Layer Risk Analysis"
     ])

show_pane1 = view_mode == "Pane 1 - Lai suat & chinh sach"
show_pane2 = view_mode == "Pane 2 - Spreads & z-score"
show_pane3 = view_mode == "Pane 3 - Risk score & Dashboard"
show_pane4 = view_mode == "Pane 4 - 3-Layer Risk Analysis"

// =====================
// 2) NHáº¬P Dá»® LIá»†U
// =====================
policy_rate     = request.security("VNINTR", timeframe.period, close)
bond_2y         = request.security("VN02Y",  timeframe.period, close)
bond_10y        = request.security("VN10Y",  timeframe.period, close)
us_10y          = request.security("US10Y",  timeframe.period, close)
interbank_rate  = request.security("VNINBR", timeframe.period, close)

// =====================
// 3) SPREADS
// =====================
liquidity_stress        = interbank_rate - policy_rate
yield_curve_standard    = bond_10y - bond_2y
intl_yield_diff         = bond_10y - us_10y
long_short_spread       = bond_10y - policy_rate

hline(0, "0", color=color.new(color.gray, 80), linestyle=hline.style_dashed)

// =====================
// 4) NGÆ¯á» NG TÄ¨NH & Z-SCORE
// =====================
threshold_mode = input.string("Dynamic (z-score)", "Che do nguong", options = ["Static", "Dynamic (z-score)"])

stress_threshold    = input.float(1.5, "Nguong Cang thanh khoan (diem %)", step=0.1)
curve_threshold     = input.float(0.0, "Nguong Dao nguoc (10Y-2Y)", step=0.1)
intl_threshold      = input.float(2.0, "Nguong Chenh lech QT (diem %)", step=0.1)
spread_threshold    = input.float(3.0, "Nguong Spread ngan-dai (diem %)", step=0.1)

len_stats   = input.int(252, "Chu ky thong ke (z-score)", minval=60)
z_stress_high  = input.float( 1.5, "Z cao â€“ Cang thanh khoan", step=0.1)
z_stress_low   = input.float(-1.0, "Z thap â€“ Cang thanh khoan", step=0.1)
z_curve_low    = input.float(-1.0, "Z thap â€“ Yield curve (10Y-2Y)", step=0.1)
z_intl_low     = input.float(-1.0, "Z thap â€“ Chenh lech QT", step=0.1)
z_spread_low   = input.float(-1.0, "Z thap â€“ Spread ngan-dai", step=0.1)

stress_z  = f_zscore(liquidity_stress, len_stats)
curve_z   = f_zscore(yield_curve_standard, len_stats)
intl_z    = f_zscore(intl_yield_diff, len_stats)
spread_z  = f_zscore(long_short_spread, len_stats)

use_dynamic = threshold_mode == "Dynamic (z-score)"

// =====================
// 5) TÃN HIá»†U 4 TRá»¤
// =====================
bool stress_high    = false
bool stress_low     = false
bool curve_inversion= false
bool intl_warning   = false
bool spread_warning = false

if use_dynamic
    stress_high     := stress_z > z_stress_high
    stress_low      := stress_z < z_stress_low
else
    stress_high     := liquidity_stress > stress_threshold
    stress_low      := liquidity_stress < -stress_threshold * 0.5

if use_dynamic
    curve_inversion := curve_z < z_curve_low
else
    curve_inversion := yield_curve_standard < curve_threshold

if use_dynamic
    intl_warning := intl_z < z_intl_low
else
    intl_warning := intl_yield_diff < intl_threshold

if use_dynamic
    spread_warning := spread_z < z_spread_low
else
    spread_warning := long_short_spread < spread_threshold

// =====================
// 6) PHÃ‚N TÃCH 3 Lá»šP Rá»¦I RO
// =====================
show_risk_layers = input.bool(true, "ðŸ”½ Hien thi phan tich 3 lop rui ro")

layer1_weight_stress = input.int(3, "ðŸŸ¥ Lop 1: Trong so Cang thanh khoan", minval=1, maxval=5)
layer1_weight_curve_funding = input.int(1, "ðŸŸ¥ Lop 1: Trong so Curve (funding proxy)", minval=0, maxval=2)

layer1_score = 0.0
layer1_score := (stress_high ? layer1_weight_stress : 0) + (curve_inversion ? layer1_weight_curve_funding : 0)
layer1_max = layer1_weight_stress + layer1_weight_curve_funding
layer1_pct = layer1_max > 0 ? (layer1_score / layer1_max) * 100 : 0.0

layer2_weight_curve_macro = input.int(3, "ðŸŸ¨ Lop 2: Trong so Yield curve (10Y-2Y)", minval=1, maxval=5)
layer2_weight_spread = input.int(2, "ðŸŸ¨ Lop 2: Trong so Spread ngan-dai", minval=1, maxval=5)

layer2_score = 0.0
layer2_score := (curve_inversion ? layer2_weight_curve_macro : 0) + (spread_warning ? layer2_weight_spread : 0)
layer2_max = layer2_weight_curve_macro + layer2_weight_spread
layer2_pct = layer2_max > 0 ? (layer2_score / layer2_max) * 100 : 0.0

layer3_weight_intl = input.int(2, "ðŸŸ¦ Lop 3: Trong so Chenh lech QT", minval=1, maxval=5)
layer3_weight_fx = input.int(1, "ðŸŸ¦ Lop 3: Trong so FX pressure", minval=1, maxval=5)

layer3_score = 0.0
layer3_score := (intl_warning ? layer3_weight_intl : 0) + (stress_high and intl_warning ? layer3_weight_fx : 0)
layer3_max = layer3_weight_intl + layer3_weight_fx
layer3_pct = layer3_max > 0 ? (layer3_score / layer3_max) * 100 : 0.0

// =====================
// 7) RISK SCORE Tá»”NG Há»¢P
// =====================
w_stress = input.int(2, "Trong so Cang thanh khoan")
w_curve  = input.int(2, "Trong so Yield curve (10Y-2Y)")
w_intl   = input.int(1, "Trong so Chenh lech QT")
w_spread = input.int(1, "Trong so Spread ngan-dai")

int risk_score = 0
risk_score := 0
if stress_high
    risk_score += w_stress
if curve_inversion
    risk_score += w_curve
if intl_warning
    risk_score += w_intl
if spread_warning
    risk_score += w_spread

max_score  = w_stress + w_curve + w_intl + w_spread
risk_ratio = max_score > 0 ? risk_score / max_score : 0.0
risk_pct   = risk_ratio * 100.0

color risk_base =
     risk_ratio == 0 ? color.new(color.green, 0) :
     risk_ratio <= 0.25 ? color.new(color.lime, 0) :
     risk_ratio <= 0.5 ? color.new(color.yellow, 0) :
     risk_ratio <= 0.75 ? color.new(color.orange, 0) :
     color.new(color.red, 0)

color risk_bg   = color.new(risk_base, 92)
color risk_fill = color.new(risk_base, 85)

// =====================
// 8) PANE 1 â€“ LÃƒI SUáº¤T & CHÃNH SÃCH
// =====================
show_pane1_labels = input.bool(true, "Pane 1: Show line labels (last bar)")

plot(show_pane1 ? bond_10y       : na, title="VN10Y",        color=color.new(color.orange, 0), linewidth=2)
plot(show_pane1 ? bond_2y        : na, title="VN02Y",        color=color.new(color.purple, 0), linewidth=2)
plot(show_pane1 ? interbank_rate : na, title="VN Interbank", color=color.new(color.teal,   0), linewidth=2)
plot(show_pane1 ? policy_rate    : na, title="SBV Policy",   color=color.new(color.red,    0), linewidth=2)
plot(show_pane1 ? us_10y         : na, title="US10Y",        color=color.new(color.blue,  40), linewidth=1)

var label p1_l1 = na
var label p1_l2 = na
var label p1_l3 = na
var label p1_l4 = na
var label p1_l5 = na

if barstate.islast
    f_delLabel(p1_l1)
    f_delLabel(p1_l2)
    f_delLabel(p1_l3)
    f_delLabel(p1_l4)
    f_delLabel(p1_l5)
    if show_pane1 and show_pane1_labels
        p1_l1 := label.new(bar_index, bond_10y,       "VN10Y",        style=label.style_label_left, textcolor=color.white, color=color.new(color.orange, 10))
        p1_l2 := label.new(bar_index, bond_2y,        "VN02Y",        style=label.style_label_left, textcolor=color.white, color=color.new(color.purple, 10))
        p1_l3 := label.new(bar_index, interbank_rate, "VN Interbank", style=label.style_label_left, textcolor=color.white, color=color.new(color.teal,   10))
        p1_l4 := label.new(bar_index, policy_rate,    "SBV Policy",   style=label.style_label_left, textcolor=color.white, color=color.new(color.red,    10))
        p1_l5 := label.new(bar_index, us_10y,         "US10Y",        style=label.style_label_left, textcolor=color.white, color=color.new(color.blue,   30))

// =====================
// 9) PANE 2 â€“ SPREADS / Z-SCORE
// =====================
pane2_view = input.string("Spreads", "Pane 2: Hien thi", options=["Spreads","Z-scores"])
show_pane2_events = input.bool(true, "Pane 2: Event markers (edge)")
show_pane2_labels = input.bool(true, "Pane 2: Show line labels (last bar)")

use_spreads = pane2_view == "Spreads"
use_zscores = pane2_view == "Z-scores"

p2_a = use_spreads ? liquidity_stress : stress_z
p2_b = use_spreads ? yield_curve_standard : curve_z
p2_c = use_spreads ? intl_yield_diff : intl_z
p2_d = use_spreads ? long_short_spread : spread_z

name_a = use_spreads ? "Liquidity stress (IB-Pol)" : "Z Liquidity stress"
name_b = use_spreads ? "Yield curve (10Y-2Y)" : "Z Yield curve"
name_c = use_spreads ? "Intl yield diff (VN-US)" : "Z Intl yield diff"
name_d = use_spreads ? "Long-short spread (10Y-Pol)" : "Z Long-short spread"

plot(show_pane2 and use_spreads ? liquidity_stress : na, title="Liquidity stress (IB-Pol)", color=color.new(#FF6B6B, 0), linewidth=2)
plot(show_pane2 and use_spreads ? yield_curve_standard : na, title="Yield curve (10Y-2Y)", color=color.new(#4ECDC4, 0), linewidth=2)
plot(show_pane2 and use_spreads ? intl_yield_diff : na, title="Intl yield diff (VN-US)", color=color.new(#45B7D1, 0), linewidth=2)
plot(show_pane2 and use_spreads ? long_short_spread : na, title="Long-short spread (10Y-Pol)", color=color.new(#96CEB4, 0), linewidth=2)

plot(show_pane2 and use_zscores ? stress_z : na, title="Z Liquidity stress", color=color.new(#FF6B6B, 0), linewidth=2)
plot(show_pane2 and use_zscores ? curve_z : na, title="Z Yield curve (10Y-2Y)", color=color.new(#4ECDC4, 0), linewidth=2)
plot(show_pane2 and use_zscores ? intl_z : na, title="Z Intl yield diff", color=color.new(#45B7D1, 0), linewidth=2)
plot(show_pane2 and use_zscores ? spread_z : na, title="Z Long-short spread", color=color.new(#96CEB4, 0), linewidth=2)

stress_high_evt = show_pane2 and show_pane2_events and stress_high and not stress_high[1]
inv_evt         = show_pane2 and show_pane2_events and curve_inversion and not curve_inversion[1]
fx_evt          = show_pane2 and show_pane2_events and intl_warning and not intl_warning[1]
spread_evt      = show_pane2 and show_pane2_events and spread_warning and not spread_warning[1]

plotshape(stress_high_evt, title="Evt Stress High", style=shape.triangledown, location=location.top, color=color.red,    size=size.tiny)
plotshape(inv_evt,         title="Evt Curve Inversion",   style=shape.xcross,       location=location.top, color=color.orange, size=size.tiny)
plotshape(fx_evt,          title="Evt FX Pressure", style=shape.diamond,      location=location.top, color=color.purple, size=size.tiny)
plotshape(spread_evt,      title="Evt Spread Low",  style=shape.circle,       location=location.top, color=color.blue,   size=size.tiny)

var label p2_l1 = na
var label p2_l2 = na
var label p2_l3 = na
var label p2_l4 = na

if barstate.islast
    f_delLabel(p2_l1)
    f_delLabel(p2_l2)
    f_delLabel(p2_l3)
    f_delLabel(p2_l4)
    if show_pane2 and show_pane2_labels
        p2_l1 := label.new(bar_index, p2_a, name_a, style=label.style_label_left, textcolor=color.white, color=color.new(#FF6B6B, 10))
        p2_l2 := label.new(bar_index, p2_b, name_b, style=label.style_label_left, textcolor=color.white, color=color.new(#4ECDC4, 10))
        p2_l3 := label.new(bar_index, p2_c, name_c, style=label.style_label_left, textcolor=color.white, color=color.new(#45B7D1, 10))
        p2_l4 := label.new(bar_index, p2_d, name_d, style=label.style_label_left, textcolor=color.white, color=color.new(#96CEB4, 10))

// =====================
// 10) Ká»ŠCH Báº¢N VÄ¨ MÃ”
// =====================
liquidity_crisis  = stress_high and curve_inversion and intl_warning
recession_warning = curve_inversion and spread_warning
fx_pressure       = intl_warning and stress_high
inflation_proxy   = long_short_spread > spread_threshold * 1.5 and yield_curve_standard > 0

scenario_display = input.string("Latest label only", "Scenario hien thi", options=["Off","Markers on transitions","Latest label only"])

sc_show = (show_pane2 or show_pane3 or show_pane4)
sc_mark = sc_show and scenario_display == "Markers on transitions"
sc_last = sc_show and scenario_display == "Latest label only" and barstate.islast

liq_evt = sc_mark and liquidity_crisis  and not liquidity_crisis[1]
rec_evt = sc_mark and recession_warning and not recession_warning[1]
fxp_evt = sc_mark and fx_pressure       and not fx_pressure[1]
inf_evt = sc_mark and inflation_proxy   and not inflation_proxy[1]

plotshape(liq_evt, title="SC_LIQ", style=shape.square, location=location.top, color=color.red,    size=size.tiny)
plotshape(rec_evt, title="SC_REC", style=shape.square, location=location.top, color=color.orange, size=size.tiny)
plotshape(fxp_evt, title="SC_FX",  style=shape.square, location=location.top, color=color.purple, size=size.tiny)
plotshape(inf_evt, title="SC_INF", style=shape.square, location=location.top, color=color.yellow, size=size.tiny)

plotshape(sc_last and liquidity_crisis,  title="SC_LIQ_LAST", style=shape.labeldown, location=location.top, color=color.red,    text="LIQ", textcolor=color.white, size=size.small)
plotshape(sc_last and recession_warning, title="SC_REC_LAST", style=shape.labeldown, location=location.top, color=color.orange, text="REC", textcolor=color.white, size=size.small)
plotshape(sc_last and fx_pressure,       title="SC_FX_LAST",  style=shape.labeldown, location=location.top, color=color.purple, text="FX",  textcolor=color.white, size=size.small)
plotshape(sc_last and inflation_proxy,   title="SC_INF_LAST", style=shape.labeldown, location=location.top, color=color.yellow, text="INF", textcolor=color.black, size=size.small)

// =====================
// 11) PANE 3 â€“ RISK SCORE & DASHBOARD (CHá»ˆ HIá»‚N THá»Š KHI CHá»ŒN PANE 3)
// =====================
p3_risk = show_pane3 ? risk_pct : na
plot(p3_risk, title="Risk % (0-100)", color=color.new(color.white, 0), linewidth=2, style=plot.style_stepline)
plot(p3_risk, title="Risk fill", style=plot.style_area, color=show_pane3 ? risk_fill : na)
bgcolor(show_pane3 ? risk_bg : na, title="Risk background")

// Táº¡o biáº¿n table cho Pane 3
var table risk_table = na
var table dashboard = na

// Cáº­p nháº­t báº£ng CHá»ˆ KHI á»Ÿ Pane 3
if barstate.islast
    // XÃ³a báº£ng cÅ© náº¿u Ä‘ang khÃ´ng á»Ÿ Pane 3
    if not show_pane3
        if not na(risk_table)
            table.delete(risk_table)
            risk_table := na
        if not na(dashboard)
            table.delete(dashboard)
            dashboard := na
    // Táº¡o báº£ng má»›i náº¿u á»Ÿ Pane 3
    else if show_pane3
        // XÃ³a báº£ng cÅ© trÆ°á»›c (náº¿u cÃ³)
        if not na(risk_table)
            table.delete(risk_table)
        if not na(dashboard)
            table.delete(dashboard)
        
        // Táº¡o báº£ng má»›i vá»›i vá»‹ trÃ­ vÃ  kÃ­ch thÆ°á»›c
        risk_table := table.new(position.top_right, 2, 7, 
             bgcolor=color.new(color.black, 25), 
             border_width=2, 
             border_color=color.new(color.white, 20))
        
        dashboard := table.new(position.bottom_right, 3, 7,
             bgcolor=color.new(color.black, 10),
             border_width=2,
             border_color=color.new(color.white, 20))
        
        show_z_in_dash = input.bool(true, "Pane 3: Dashboard show z-score (when Dynamic)")
        
        // ===== Risk table =====
        table.merge_cells(risk_table, 0, 0, 1, 0)
        table.cell(risk_table, 0, 0, " HE THONG CANH BAO VI MO CHUAN ",
             bgcolor=color.new(color.blue, 0), text_color=color.white, text_size=size.normal)
        
        table.merge_cells(risk_table, 0, 1, 1, 1)
        table.cell(risk_table, 0, 1, "âœ“ Dung duong cong loi suat chuan (10Y-2Y)",
             bgcolor=color.new(#4CAF50, 30), text_color=color.white, text_size=size.tiny)

        table.cell(risk_table, 0, 2, " Cang TK ",  bgcolor=stress_high ? color.red : color.green, text_color=color.white, text_size=size.small)
        table.cell(risk_table, 0, 3, " Yield curve ", bgcolor=curve_inversion ? color.red : color.green, text_color=color.white, text_size=size.small)
        table.cell(risk_table, 0, 4, " Intl diff ", bgcolor=intl_warning ? color.red : color.green, text_color=color.white, text_size=size.small)
        table.cell(risk_table, 0, 5, " Long-short ", bgcolor=spread_warning ? color.red : color.green, text_color=color.white, text_size=size.small)

        table.cell(risk_table, 1, 2, stress_high ? " CAO " : " ON ", bgcolor=stress_high ? color.red : color.green, text_color=color.white, text_size=size.small)
        table.cell(risk_table, 1, 3, curve_inversion ? " DAO " : " ON ", bgcolor=curve_inversion ? color.red : color.green, text_color=color.white, text_size=size.small)
        table.cell(risk_table, 1, 4, intl_warning ? " THAP " : " ON ", bgcolor=intl_warning ? color.red : color.green, text_color=color.white, text_size=size.small)
        table.cell(risk_table, 1, 5, spread_warning ? " THAP " : " ON ", bgcolor=spread_warning ? color.red : color.green, text_color=color.white, text_size=size.small)

        // ===== Dashboard =====
        table.merge_cells(dashboard, 0, 0, 2, 0)
        table.cell(dashboard, 0, 0, " DASHBOARD VI MO CHUAN ",
             bgcolor=color.new(color.blue, 0), text_color=color.white, text_size=size.normal)

        table.cell(dashboard, 0, 1, " Chi bao ", bgcolor=color.new(color.white, 5), text_color=color.black, text_size=size.small)
        table.cell(dashboard, 1, 1, " Gia tri ", bgcolor=color.new(color.white, 5), text_color=color.black, text_size=size.small)
        table.cell(dashboard, 2, 1, " Trang thai ", bgcolor=color.new(color.white, 5), text_color=color.black, text_size=size.small)

        st1 = stress_high ? "CANG THANG" : "ON"
        st2 = curve_inversion ? "DAO NGUOC" : "ON"
        st3 = intl_warning ? "AP LUC FX" : "AN TOAN"
        st4 = spread_warning ? "THAP" : "CAO"

        v1 = use_dynamic and show_z_in_dash ? stress_z : liquidity_stress
        v2 = use_dynamic and show_z_in_dash ? curve_z : yield_curve_standard
        v3 = use_dynamic and show_z_in_dash ? intl_z : intl_yield_diff
        v4 = use_dynamic and show_z_in_dash ? spread_z : long_short_spread

        table.cell(dashboard, 0, 2, " Liquidity stress\n(IB-Policy) ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 1, 2, " " + str.tostring(v1, "#.##") + " ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 2, 2, " " + st1 + " ", bgcolor=f_statusColor(st1), text_color=color.white, text_size=size.small)

        table.cell(dashboard, 0, 3, " Yield curve\n(10Y-2Y) ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 1, 3, " " + str.tostring(v2, "#.##") + " ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 2, 3, " " + st2 + " ", bgcolor=f_statusColor(st2), text_color=color.white, text_size=size.small)

        table.cell(dashboard, 0, 4, " Intl yield diff\n(VN10Y-US10Y) ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 1, 4, " " + str.tostring(v3, "#.##") + " ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 2, 4, " " + st3 + " ", bgcolor=f_statusColor(st3), text_color=color.white, text_size=size.small)

        table.cell(dashboard, 0, 5, " Long-short spread\n(10Y-Policy) ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 1, 5, " " + str.tostring(v4, "#.##") + " ", bgcolor=color.new(color.black, 20), text_color=color.white, text_size=size.small)
        table.cell(dashboard, 2, 5, " " + st4 + " ", bgcolor=f_statusColor(st4), text_color=color.white, text_size=size.small)

        scen = "BINH THUONG"
        scol = color.new(color.green, 0)
        if liquidity_crisis
            scen := "KHUNG HOANG THANH KHOAN"
            scol := color.new(color.red, 0)
        else if recession_warning
            scen := "CANH BAO SUY THOAI (Chuan)"
            scol := color.new(color.orange, 0)
        else if fx_pressure
            scen := "AP LUC TY GIA"
            scol := color.new(color.purple, 0)
        else if inflation_proxy
            scen := "PROXY LAM PHAT CAO"
            scol := color.new(color.yellow, 0)

        table.cell(dashboard, 0, 6, " KICH BAN: ", bgcolor=color.new(color.white, 5), text_color=color.black, text_size=size.small)
        table.merge_cells(dashboard, 1, 6, 2, 6)
        table.cell(dashboard, 1, 6, " " + scen + " ", bgcolor=scol, text_color=f_textColorForBg(scol), text_size=size.small)

// =====================
// 12) PANE 4 â€“ 3-LAYER RISK ANALYSIS (CHá»ˆ HIá»‚N THá»Š KHI CHá»ŒN PANE 4)
// =====================

// --- Váº¼ Äá»’ THá»Š 3 Lá»šP ---
plot(show_pane4 ? layer1_pct : na, title="ðŸŸ¥ Lá»›p 1: Rá»§i ro Thanh khoáº£n", color=color.new(#FF6B6B, 0), linewidth=3)
plot(show_pane4 ? layer2_pct : na, title="ðŸŸ¨ Lá»›p 2: Rá»§i ro Chu ká»³ vÄ© mÃ´", color=color.new(#FFA726, 0), linewidth=3)
plot(show_pane4 ? layer3_pct : na, title="ðŸŸ¦ Lá»›p 3: Rá»§i ro Ngoáº¡i vi", color=color.new(#42A5F5, 0), linewidth=3)

// --- THÃŠM ÄÆ¯á»œNG THAM CHIáº¾U VÃ€ CHÃš THÃCH ---
hline(80, "Ráº¥t Cao (80%)", color=color.new(color.red, 50), linestyle=hline.style_dotted, editable=false)
hline(60, "Cao (60%)", color=color.new(color.orange, 50), linestyle=hline.style_dotted, editable=false)
hline(40, "Trung bÃ¬nh (40%)", color=color.new(color.yellow, 50), linestyle=hline.style_dotted, editable=false)
hline(20, "Tháº¥p (20%)", color=color.new(color.green, 50), linestyle=hline.style_dotted, editable=false)

// TÃ´ mÃ u ná»n vÃ¹ng rá»§i ro
bgcolor(show_pane4 and layer1_pct >= 60 ? color.new(#FF6B6B, 85) : na, title="VÃ¹ng rá»§i ro Lá»›p 1 Cao")
bgcolor(show_pane4 and layer2_pct >= 60 ? color.new(#FFA726, 85) : na, title="VÃ¹ng rá»§i ro Lá»›p 2 Cao")
bgcolor(show_pane4 and layer3_pct >= 60 ? color.new(#42A5F5, 85) : na, title="VÃ¹ng rá»§i ro Lá»›p 3 Cao")

// Táº¡o biáº¿n table cho Pane 4
var table guide_table = na
var table layer_table = na

// Cáº­p nháº­t báº£ng CHá»ˆ KHI á»Ÿ Pane 4
if barstate.islast
    // XÃ³a báº£ng cÅ© náº¿u Ä‘ang khÃ´ng á»Ÿ Pane 4
    if not show_pane4
        if not na(guide_table)
            table.delete(guide_table)
            guide_table := na
        if not na(layer_table)
            table.delete(layer_table)
            layer_table := na
    // Táº¡o báº£ng má»›i náº¿u á»Ÿ Pane 4
    else if show_pane4
        // XÃ³a báº£ng cÅ© trÆ°á»›c (náº¿u cÃ³)
        if not na(guide_table)
            table.delete(guide_table)
        if not na(layer_table)
            table.delete(layer_table)
        
        // Táº¡o báº£ng má»›i
        guide_table := table.new(position.middle_right, 3, 12, 
             bgcolor=color.new(#2E3B4E, 95), 
             border_width=1, 
             border_color=color.new(#FFFFFF, 30))
        
        layer_table := table.new(position.top_right, 4, 8,
             bgcolor=color.new(#1A237E, 95),
             border_width=2,
             border_color=color.white)
        
        // ===== Báº¢NG HÆ¯á»šNG DáºªN =====
        table.merge_cells(guide_table, 0, 0, 2, 0)
        table.cell(guide_table, 0, 0, " ðŸ“Š HÆ¯á»šNG DáºªN Äá»ŒC 3 Lá»šP Rá»¦I RO ", 
             bgcolor=color.new(#1E88E5, 0), text_color=color.white, text_size=size.normal)
        
        table.merge_cells(guide_table, 0, 1, 2, 1)
        table.cell(guide_table, 0, 1, "Há»‡ thá»‘ng tÃ¡ch rá»§i ro thÃ nh 3 lá»›p Ä‘á»™c láº­p Ä‘á»ƒ xÃ¡c Ä‘á»‹nh NGUá»’N Gá»C rá»§i ro.", 
             bgcolor=color.new(#455A64, 70), text_color=color.white, text_size=size.tiny)
        
        table.cell(guide_table, 0, 2, " ðŸŸ¥ Lá»šP 1:", bgcolor=color.new(#FF5252, 30), text_color=color.white, text_size=size.small)
        table.merge_cells(guide_table, 1, 2, 2, 2)
        table.cell(guide_table, 1, 2, "Rá»¦I RO THANH KHOáº¢N NGáº®N Háº N\nâ€¢ Táº§n suáº¥t: VÃ i ngÃ y â†’ vÃ i tuáº§n\nâ€¢ Gá»“m: CÄƒng tháº³ng IB-Policy", 
             bgcolor=color.new(#FF5252, 10), text_color=color.white, text_size=size.tiny)
        
        table.cell(guide_table, 0, 3, " ðŸŸ¨ Lá»šP 2:", bgcolor=color.new(#FF9800, 30), text_color=color.white, text_size=size.small)
        table.merge_cells(guide_table, 1, 3, 2, 3)
        table.cell(guide_table, 1, 3, "Rá»¦I RO CHU Ká»² VÄ¨ MÃ”\nâ€¢ Táº§n suáº¥t: VÃ i thÃ¡ng â†’ vÃ i quÃ½\nâ€¢ Gá»“m: Yield curve (10Y-2Y) + Long-Short Spread", 
             bgcolor=color.new(#FF9800, 10), text_color=color.white, text_size=size.tiny)
        
        table.cell(guide_table, 0, 4, " ðŸŸ¦ Lá»šP 3:", bgcolor=color.new(#2196F3, 30), text_color=color.white, text_size=size.small)
        table.merge_cells(guide_table, 1, 4, 2, 4)
        table.cell(guide_table, 1, 4, "Rá»¦I RO NGOáº I VI\nâ€¢ Táº§n suáº¥t: VÃ i tuáº§n â†’ vÃ i thÃ¡ng\nâ€¢ Gá»“m: ChÃªnh lá»‡ch QT + Ãp lá»±c FX", 
             bgcolor=color.new(#2196F3, 10), text_color=color.white, text_size=size.tiny)
        
        table.merge_cells(guide_table, 0, 5, 2, 5)
        table.cell(guide_table, 0, 5, " ðŸŽ¯ THANG ÄIá»‚M ÄÃNH GIÃ (%)", 
             bgcolor=color.new(#546E7A, 50), text_color=color.white, text_size=size.small)
        
        table.cell(guide_table, 0, 6, "0-20%", bgcolor=color.new(#4CAF50, 70), text_color=color.white, text_size=size.small)
        table.merge_cells(guide_table, 1, 6, 2, 6)
        table.cell(guide_table, 1, 6, "Ráº¥t tháº¥p / á»”n Ä‘á»‹nh", 
             bgcolor=color.new(#4CAF50, 20), text_color=color.white, text_size=size.tiny)
        
        table.cell(guide_table, 0, 7, "20-40%", bgcolor=color.new(#8BC34A, 70), text_color=color.white, text_size=size.small)
        table.merge_cells(guide_table, 1, 7, 2, 7)
        table.cell(guide_table, 1, 7, "Tháº¥p / Cáº§n theo dÃµi", 
             bgcolor=color.new(#8BC34A, 20), text_color=color.white, text_size=size.tiny)
        
        table.cell(guide_table, 0, 8, "40-60%", bgcolor=color.new(#FFC107, 70), text_color=color.black, text_size=size.small)
        table.merge_cells(guide_table, 1, 8, 2, 8)
        table.cell(guide_table, 1, 8, "Trung bÃ¬nh / Cáº£nh giÃ¡c", 
             bgcolor=color.new(#FFC107, 20), text_color=color.white, text_size=size.tiny)
        
        table.cell(guide_table, 0, 9, "60-80%", bgcolor=color.new(#FF9800, 70), text_color=color.white, text_size=size.small)
        table.merge_cells(guide_table, 1, 9, 2, 9)
        table.cell(guide_table, 1, 9, "Cao / Cáº£nh bÃ¡o", 
             bgcolor=color.new(#FF9800, 20), text_color=color.white, text_size=size.tiny)
        
        table.cell(guide_table, 0, 10, "80-100%", bgcolor=color.new(#F44336, 70), text_color=color.white, text_size=size.small)
        table.merge_cells(guide_table, 1, 10, 2, 10)
        table.cell(guide_table, 1, 10, "Ráº¥t cao / Nguy hiá»ƒm", 
             bgcolor=color.new(#F44336, 20), text_color=color.white, text_size=size.tiny)
        
        table.merge_cells(guide_table, 0, 11, 2, 11)
        application_text = " ðŸ’¡ á»¨NG Dá»¤NG THá»°C Táº¾:\n"
        application_text := application_text + "â€¢ Lá»›p 1 cao: Cáº£nh giÃ¡c vá»›i cá»• phiáº¿u ngÃ¢n hÃ ng, trÃ¡i phiáº¿u ngáº¯n háº¡n\n"
        application_text := application_text + "â€¢ Lá»›p 2 cao: Xem xÃ©t giáº£m tá»· trá»ng cá»• phiáº¿u chu ká»³\n"
        application_text := application_text + "â€¢ Lá»›p 3 cao: Theo dÃµi sÃ¡t tá»· giÃ¡ vÃ  dÃ²ng vá»‘n ngoáº¡i"
        
        table.cell(guide_table, 0, 11, application_text, 
             bgcolor=color.new(#37474F, 60), text_color=color.white, text_size=size.tiny)
        
        // ===== Báº¢NG Káº¾T QUáº¢ PHÃ‚N TÃCH =====
        table.merge_cells(layer_table, 0, 0, 3, 0)
        table.cell(layer_table, 0, 0, " ðŸ“ˆ PHÃ‚N TÃCH 3 Lá»šP Rá»¦I RO - Káº¾T QUáº¢ ", 
             bgcolor=color.new(#0D47A1, 0), text_color=color.white, text_size=size.normal)
        
        table.cell(layer_table, 0, 1, " Lá»šP Rá»¦I RO ", bgcolor=color.new(#3949AB, 0), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 1, 1, " ÄIá»‚M ", bgcolor=color.new(#3949AB, 0), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 2, 1, " Tá»¶ Lá»† ", bgcolor=color.new(#3949AB, 0), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 3, 1, " ÄÃNH GIÃ ", bgcolor=color.new(#3949AB, 0), text_color=color.white, text_size=size.small)
        
        layer1_status = layer1_pct >= 80 ? "N.G.HIá»‚M" : layer1_pct >= 60 ? "CAO" : layer1_pct >= 40 ? "T.BÃŒNH" : layer1_pct >= 20 ? "THáº¤P" : "R.THáº¤P"
        layer1_bg = f_layerColor(layer1_pct)
        
        table.cell(layer_table, 0, 2, " Thanh khoáº£n ", 
             bgcolor=color.new(#FF5252, 20), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 1, 2, str.tostring(layer1_score, "#.0") + "/" + str.tostring(layer1_max), 
             bgcolor=color.new(#FF5252, 20), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 2, 2, str.tostring(layer1_pct, "#.0") + "%", 
             bgcolor=layer1_bg, text_color=color.white, text_size=size.small)
        table.cell(layer_table, 3, 2, " " + layer1_status + " ", 
             bgcolor=layer1_bg, text_color=color.white, text_size=size.small)
        
        layer2_status = layer2_pct >= 80 ? "NÃ“NG (Äáº¢O)" : layer2_pct >= 60 ? "áº¤M" : layer2_pct >= 40 ? "TR.TÃNH" : layer2_pct >= 20 ? "MÃT" : "Láº NH"
        layer2_bg = f_layerColor(layer2_pct)
        
        table.cell(layer_table, 0, 3, " Chu ká»³ VM ", 
             bgcolor=color.new(#FF9800, 20), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 1, 3, str.tostring(layer2_score, "#.0") + "/" + str.tostring(layer2_max), 
             bgcolor=color.new(#FF9800, 20), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 2, 3, str.tostring(layer2_pct, "#.0") + "%", 
             bgcolor=layer2_bg, text_color=color.white, text_size=size.small)
        table.cell(layer_table, 3, 3, " " + layer2_status + " ", 
             bgcolor=layer2_bg, text_color=color.white, text_size=size.small)
        
        layer3_status = layer3_pct >= 80 ? "Máº NH" : layer3_pct >= 60 ? "Vá»ªA" : layer3_pct >= 40 ? "T.BÃŒNH" : layer3_pct >= 20 ? "Yáº¾U" : "R.Yáº¾U"
        layer3_bg = f_layerColor(layer3_pct)
        
        table.cell(layer_table, 0, 4, " Ngoáº¡i vi ", 
             bgcolor=color.new(#2196F3, 20), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 1, 4, str.tostring(layer3_score, "#.0") + "/" + str.tostring(layer3_max), 
             bgcolor=color.new(#2196F3, 20), text_color=color.white, text_size=size.small)
        table.cell(layer_table, 2, 4, str.tostring(layer3_pct, "#.0") + "%", 
             bgcolor=layer3_bg, text_color=color.white, text_size=size.small)
        table.cell(layer_table, 3, 4, " " + layer3_status + " ", 
             bgcolor=layer3_bg, text_color=color.white, text_size=size.small)
        
        table.merge_cells(layer_table, 0, 5, 3, 5)
        total_judgement = ""
        detail_analysis = ""
        
        if layer2_pct >= 70 and curve_inversion
            total_judgement := "âš ï¸ Cáº¢NH BÃO SUY THOAI Máº NH"
            detail_analysis := "ÄÆ°á»ng cong (10Y-2Y) Ä‘áº£o ngÆ°á»£c + Äiá»ƒm chu ká»³ ráº¥t cao"
        else if layer1_pct >= 60 and layer2_pct >= 60
            total_judgement := "âš ï¸ CÄ‚NG THáº²NG TOÃ€N DIá»†N"
            detail_analysis := "Cáº£ thanh khoáº£n láº«n chu ká»³ Ä‘á»u á»Ÿ má»©c bÃ¡o Ä‘á»™ng"
        else if layer1_pct >= 60
            total_judgement := "ðŸ“‰ Rá»¦I RO THANH KHOáº¢N CAO"
            detail_analysis := "Há»‡ thá»‘ng ngÃ¢n hÃ ng cÃ³ thá»ƒ gáº·p Ã¡p lá»±c ngáº¯n háº¡n"
        else if layer2_pct >= 60
            total_judgement := "ðŸ“Š TRIá»‚N Vá»ŒNG VÄ¨ MÃ” Xáº¤U"
            detail_analysis := "TÃ­n hiá»‡u dÃ i háº¡n tá»« yield curve Ä‘Ã¡ng lo ngáº¡i"
        else if layer3_pct >= 60
            total_judgement := "ðŸŒ ÃP Lá»°C Tá»ª BÃŠN NGOÃ€I"
            detail_analysis := "Rá»§i ro tá»· giÃ¡ vÃ  dÃ²ng vá»‘n quá»‘c táº¿ gia tÄƒng"
        else
            total_judgement := "âœ… MÃ”I TRÆ¯á»œNG á»”N Äá»ŠNH"
            detail_analysis := "KhÃ´ng cÃ³ rá»§i ro Ä‘Ã¡ng ká»ƒ á»Ÿ cáº£ 3 máº·t tráº­n"
        
        table.cell(layer_table, 0, 5, " " + total_judgement + " ", 
             bgcolor=color.new(#4CAF50, 0), text_color=color.white, text_size=size.normal)
        
        table.merge_cells(layer_table, 0, 6, 3, 6)
        table.cell(layer_table, 0, 6, " " + detail_analysis + " ", 
             bgcolor=color.new(#37474F, 70), text_color=color.white, text_size=size.tiny)
        
        table.merge_cells(layer_table, 0, 7, 3, 7)
        action_text = "ðŸ‘‰ HÃ€NH Äá»˜NG: "
        if layer1_pct >= 60
            action_text := action_text + "Theo dÃµi sÃ¡t thanh khoáº£n | "
        if layer2_pct >= 60
            action_text := action_text + "Giáº£m rá»§i ro vÄ© mÃ´ | "
        if layer3_pct >= 60
            action_text := action_text + "Báº£o vá»‡ trÆ°á»›c biáº¿n Ä‘á»™ng FX"
        if action_text == "ðŸ‘‰ HÃ€NH Äá»˜NG: "
            action_text := action_text + "Duy trÃ¬ chiáº¿n lÆ°á»£c hiá»‡n táº¡i"
        
        table.cell(layer_table, 0, 7, action_text, 
             bgcolor=color.new(#1565C0, 70), text_color=color.white, text_size=size.small)

// =====================
// 13) ALERT (HOáº T Äá»˜NG TRÃŠN Táº¤T Cáº¢ PANEL)
// =====================
risk_alert_level = input.int(4, "Nguong canh bao diem rui ro", minval=1)
layer1_alert = input.float(60, "Nguong canh bao Lop 1 (%)", minval=0, maxval=100)
layer2_alert = input.float(60, "Nguong canh bao Lop 2 (%)", minval=0, maxval=100)
layer3_alert = input.float(60, "Nguong canh bao Lop 3 (%)", minval=0, maxval=100)

change_threshold = input.float(0.5, "Nguong bien dong lon (diem %)", step=0.1)

big_move =
     math.abs(liquidity_stress - liquidity_stress[1]) > change_threshold or
     math.abs(yield_curve_standard - yield_curve_standard[1]) > change_threshold or
     math.abs(intl_yield_diff - intl_yield_diff[1]) > change_threshold or
     math.abs(long_short_spread - long_short_spread[1]) > change_threshold

if barstate.islast
    if layer1_pct >= layer1_alert
        alert("CANH BAO LOP 1: Rui ro thanh khoan = " + str.tostring(layer1_pct, "#.0") + "%", alert.freq_once_per_bar)
    
    if layer2_pct >= layer2_alert
        alert("CANH BAO LOP 2: Rui ro chu ky (10Y-2Y) = " + str.tostring(layer2_pct, "#.0") + "%", alert.freq_once_per_bar)
    
    if layer3_pct >= layer3_alert
        alert("CANH BAO LOP 3: Rui ro ngoai vi = " + str.tostring(layer3_pct, "#.0") + "%", alert.freq_once_per_bar)
    
    if risk_score >= risk_alert_level
        alert("CANH BAO TONG: Diem rui ro = " + str.tostring(risk_score) + "/" + str.tostring(max_score), alert.freq_once_per_bar)
    
    if liquidity_crisis
        alert("CANH BAO KHAN: Khung hoang thanh khoan", alert.freq_once_per_bar)
    
    if big_move
        alert("CANH BAO: Bien dong lon cac chi bao", alert.freq_once_per_bar)
